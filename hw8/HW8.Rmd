---
title: "Assignment 8"
author: "Colin Eberl-Coe"
date: "5 April 2016"
output: pdf_document
header-includes: \usepackage{bm,amsmath}
---
***
```{r, include=FALSE}
rm(list=ls())
load(paste(getwd(),"/.RData",sep=""))
list.of.packages <- c("sp", "dplyr", "stringr","spatstat","fields","gstat","lattice","ggplot2",
                      "knitr","spdep","maptools")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
invisible(lapply(list.of.packages, library, character.only = TRUE))
select <- dplyr::select
rm(list.of.packages,new.packages)
```

### 1. Intro to `spatstat`.  

  * For each of $\lambda = 10,20,100$, generate five realizations of CSR on the unit square 


\begin{figure}[ht!]
  \includegraphics{csr.PNG}
\end{figure}

  * Compute and report $\hat{\lambda}(\vec{s})_i$, $b_i$ for $i=1,2,3$; the values of lambda used above. 
  
```{r constant intensities,echo=F}
lam.true <- c(rep(10,5),rep(20,5),rep(100,5))
v <- vector("list",length(lam.true))
for(i in 1:length(lam.true)){
  v[[i]] <- rpoispp(lam.true[i])
}
n <- sapply(v, function(x) x$n)
D <- sapply(v, area)
d <- 2
x <- sapply(v, function(p) p$x)
y <- sapply(v, function(p) p$y)
sigma.hat <- sapply(v,function(p) { sd(c(p$x, p$y))})
b <- sigma.hat*n^(-1/(d+4))
lam.hat <- n/D
as.data.frame(cbind(lam.true,lam.hat,b))
```

  * Plot the nonparametric estimates of $\lambda$ using $b$ found above.
\begin{figure}[ht!]
  \includegraphics[width=0.75\textwidth]{kde.JPEG}
\end{figure}

  * How do the sets of five estimates of $\lambda(\vec{s})$ compare to the known constant values of $\lambda$?
  
  The estimate of $\lambda$ is $n/D$, the number of points generated divided by the area of the domain, and is close to the known value of $\lambda$ used in the simulation, as the above table demonstrates. However, looking at plots of the spatially-varying intensity returned by R, even though the intensity is known to be constant, the five realizations are different enough that interpreting a single realization could very easily lead to incorrect inference. 
  
  * Simulate 100 realizations of HPP and average their nonparametrically-estimated intensities. Plot this and compare. 
  
```{r average of simulated HPPs, echo=F,fig.width=6,fig.height=4}
par(mfrow=c(1,1))
simulate_averaged_hpp <- function(n_samples){
  w <-lapply(vector("list",length=n_samples),function(x){rpoispp(lambda=20)})
  # N <- sapply(w,function(x) x$n)
  # sigmahat <- sapply(w, function(p) { sd(c(p$x,p$y))})
  # B <- sigmahat*N^(-1/(d+4))
  lambda.hat <- density.ppplist(x = w, sigma=bw.scott)
  V <- lapply(X = lambda.hat,FUN = function(x) {x$v})
  #plot(lambda.hat)
  L <- rep(NA,n_samples)
  M <- matrix(NA,128,128)
  for(i in 1:128){
    for(j in 1:128){
      for(k in 1:100){
        L[k] <- V[[k]][i,j]
        M[i,j] <- mean(L)
      }
    }
  }
  return(as.im(M))
}
M <- simulate_averaged_hpp(100)
plot(as.im(M), main=expression(paste("Average of 100 simulations of ", hat(lambda), " per pixel")))
```

This averaged estimate is naturally much less variable than the estimate of any given realization. As the amount of simulation trials increases, the image plot would gradually become homogeneous in color, due to the estimate being more accurate per pixel. Also, the estimates that are farthest from the true value of $\lambda$ are those near the edges; this could be ameliorated somewhat by specifying the `edges=` command inside `density.ppp`. 

### 2. Plot data and use the $L(h)$ function to test CSR. 

  * First dataset, `anemones`:
```{r anemones, echo=F,fig.width=6,fig.height=4}
plot(anemones)
L.anem <- envelope(anemones,Lest,99,verbose=F)
plot(L.anem,main = expression(paste("Plot of ", hat(L)(r), " for the anemones data")))
```

Based on the simulated datsets, the observed `anemones` data exhibits significantly fewer events at small values of $h$ than would be expected under Complete Spatial Randomness. Once $h$ is approximately greater than 30, the data follow CSR fairly closely, but for almost half of the data the observed $\hat{L}(h)$ is outside of the simulated envelopes, meaning there is evidence against CSR in these data. 

  * Second dataset, `ants`: 
```{r ants, echo=F,fig.width=6,fig.height=4}
plot(ants)
L.ants <- envelope(ants,Lest,99,verbose=F)
plot(L.ants,main = expression(paste("Plot of ", hat(L)(r), " for the ants data")))
```

Based on the simulated datasets, there is no significant evidence that the `ants` were not generated by a homegeneous Poisson process.

  * Third dataset, `bei`:
```{r bei, echo=F,fig.width=6,fig.height=4}
plot(bei)
L.bei <- envelope(bei, Lest, 99, verbose=F)
plot(L.bei, main = expression(paste("Plot of ", hat(L)(r), " for the rainforest data")))
```

As can be seen from the plot of the data, the events are clustered. Indeed, the $L$ function indicates that at all distances there is a higher-than-expected number of events given CSR. Therefore, there is strong evidence that the rainforest data were not generated by a homogeneous Poisson process. 